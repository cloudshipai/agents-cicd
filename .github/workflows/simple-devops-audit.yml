name: Simple DevOps Security Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Run Security Scanner Agent
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -e OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
          -e PROJECT_ROOT="/workspace" \
          station-devops-simple:latest \
          bash -c "
            echo 'PROJECT_ROOT: /workspace' > /root/.config/station/environments/default/variables.yml && \
            stn sync default -i=false && \
            stn agent run 'Security Scanner' 'Scan this repository for secrets, API keys, and basic security issues. Use gitleaks to detect any exposed credentials.' --env default
          "
      continue-on-error: false
    
    - name: Run Terraform Security Auditor
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -e OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
          -e PROJECT_ROOT="/workspace" \
          station-devops-simple:latest \
          bash -c "
            echo 'PROJECT_ROOT: /workspace' > /root/.config/station/environments/default/variables.yml && \
            stn sync default -i=false && \
            stn agent run 'Terraform Auditor' 'Analyze any Terraform configurations in this repository for security issues and compliance problems using checkov.' --env default
          "
      continue-on-error: true

    - name: Generate Security Report Summary
      run: |
        echo "# ðŸ”’ Simple DevOps Security Audit Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Audit Summary" >> $GITHUB_STEP_SUMMARY  
        echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Container**: station-devops-simple:latest" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ›¡ï¸ Security Scans Completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Security Scanner**: Secret detection with gitleaks (4 tools)" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Terraform Auditor**: Infrastructure security with checkov (10 tools)" >> $GITHUB_STEP_SUMMARY  
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”§ Tools Used (28 total)" >> $GITHUB_STEP_SUMMARY
        echo "- **Secret Detection**: gitleaks for exposed credentials" >> $GITHUB_STEP_SUMMARY
        echo "- **Infrastructure Security**: checkov for Terraform analysis" >> $GITHUB_STEP_SUMMARY
        echo "- **File Access**: filesystem tools for code analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "_Powered by [Station DevOps Platform](https://station.dev) with Ship CLI Security Tools_ ðŸš€" >> $GITHUB_STEP_SUMMARY