name: Station Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Run Station Security Scanner
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -e PROJECT_ROOT=/workspace \
          -e OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
          station-cicd-security-demo:latest \
          stn agent run "CICD Security Scanner" "Perform comprehensive security analysis of this project: scan terraform files for misconfigurations, docker files for vulnerabilities, and Python code for security issues. Focus on critical and high severity findings."
      continue-on-error: true
    
    - name: Generate Security Report Summary
      run: |
        echo "# 🔒 Station Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Analysis Completed:" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ **Terraform Security**: Infrastructure misconfigurations and compliance" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ **Container Security**: Docker vulnerabilities and best practices" >> $GITHUB_STEP_SUMMARY  
        echo "- ✅ **Code Security**: Python vulnerabilities and secret detection" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "See workflow logs above for detailed findings and remediation guidance." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "_🤖 Powered by [Station](https://github.com/cloudshipai/station) AI Security Agents_" >> $GITHUB_STEP_SUMMARY

    - name: Comment PR with Security Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## 🔒 Station Security Analysis Results
            
            Our AI-powered security scanner has analyzed this pull request:
            
            **Scanned Components:**
            - 🏗️ **Terraform Configuration** - Infrastructure security and compliance
            - 🐳 **Docker Images** - Container vulnerabilities and best practices  
            - 🐍 **Python Code** - Source code security and secret detection
            
            **Next Steps:**
            1. Review the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed findings
            2. Address any CRITICAL or HIGH severity issues before merging
            3. Follow the provided remediation guidance for each finding
            
            _🤖 Powered by [Station](https://github.com/cloudshipai/station) Security Agents_`
          })